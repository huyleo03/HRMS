import { apiCall, API_CONFIG } from "./api";

// ============ EMPLOYEE ENDPOINTS ============

// Check-in
export const clockIn = async (photo) => {
  try {
    return await apiCall(API_CONFIG.ENDPOINTS.CLOCK_IN, {
      method: "POST",
      body: JSON.stringify({ photo }),
    });
  } catch (error) {
    console.error("clockIn service error:", error);
    throw error;
  }
};

// Check-out
export const clockOut = async (photo) => {
  try {
    return await apiCall(API_CONFIG.ENDPOINTS.CLOCK_OUT, {
      method: "POST",
      body: JSON.stringify({ photo }),
    });
  } catch (error) {
    console.error("clockOut service error:", error);
    throw error;
  }
};

// Get today status
export const getTodayStatus = async () => {
  try {
    return await apiCall(API_CONFIG.ENDPOINTS.GET_TODAY_STATUS, {
      method: "GET",
    });
  } catch (error) {
    console.error("getTodayStatus service error:", error);
    throw error;
  }
};

// Get my history
export const getMyHistory = async (params = {}) => {
  try {
    return await apiCall(API_CONFIG.ENDPOINTS.GET_MY_HISTORY, {
      method: "GET",
      params: params,
    });
  } catch (error) {
    console.error("getMyHistory service error:", error);
    throw error;
  }
};

// ============ MANAGER ENDPOINTS ============

// Get department overview
export const getDepartmentOverview = async (params = {}) => {
  try {
    return await apiCall(API_CONFIG.ENDPOINTS.GET_DEPARTMENT_ATTENDANCE, {
      method: "GET",
      params: params,
    });
  } catch (error) {
    console.error("getDepartmentOverview service error:", error);
    throw error;
  }
};

// Get department report
export const getDepartmentReport = async (params = {}) => {
  try {
    return await apiCall(API_CONFIG.ENDPOINTS.GET_DEPARTMENT_REPORT, {
      method: "GET",
      params: params,
    });
  } catch (error) {
    console.error("getDepartmentReport service error:", error);
    throw error;
  }
};

// ============ ADMIN ENDPOINTS ============

// Get all attendance
export const getAllAttendance = async (params = {}) => {
  try {
    return await apiCall(API_CONFIG.ENDPOINTS.GET_ALL_ATTENDANCE, {
      method: "GET",
      params: params,
    });
  } catch (error) {
    console.error("getAllAttendance service error:", error);
    throw error;
  }
};

// Get company report
export const getCompanyReport = async (params = {}) => {
  try {
    return await apiCall(API_CONFIG.ENDPOINTS.GET_COMPANY_REPORT, {
      method: "GET",
      params: params,
    });
  } catch (error) {
    console.error("getCompanyReport service error:", error);
    throw error;
  }
};

// Manual adjust
export const manualAdjust = async (attendanceId, data) => {
  try {
    return await apiCall(API_CONFIG.ENDPOINTS.MANUAL_ADJUST(attendanceId), {
      method: "PUT",
      body: JSON.stringify(data),
    });
  } catch (error) {
    console.error("manualAdjust service error:", error);
    throw error;
  }
};

// Mark absent
export const markAbsent = async () => {
  try {
    return await apiCall(API_CONFIG.ENDPOINTS.MARK_ABSENT, {
      method: "POST",
    });
  } catch (error) {
    console.error("markAbsent service error:", error);
    throw error;
  }
};

// Export data
export const exportAttendanceData = async (params = {}) => {
  try {
    const token = localStorage.getItem("auth_token");
    const queryParams = new URLSearchParams(params).toString();
    const url = `${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.EXPORT_ATTENDANCE}?${queryParams}`;
    
    const response = await fetch(url, {
      method: "GET",
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });
    
    if (!response.ok) {
      throw new Error("Export failed");
    }
    
    const blob = await response.blob();
    const downloadUrl = window.URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = downloadUrl;
    link.download = `Attendance_Export_${new Date().toISOString().split('T')[0]}.xlsx`;
    document.body.appendChild(link);
    link.click();
    link.remove();
    window.URL.revokeObjectURL(downloadUrl);
    
    return { success: true };
  } catch (error) {
    console.error("exportAttendanceData service error:", error);
    throw error;
  }
};

// Ping intranet
export const pingIntranet = async () => {
  try {
    return await apiCall(API_CONFIG.ENDPOINTS.PING_INTRANET, {
      method: "GET",
    });
  } catch (error) {
    console.error("pingIntranet service error:", error);
    throw error;
  }
};
